# (PART) 等級線性迴歸模型 analysis of hierarchical and other dependent data {-}


# 相互依賴數據及簡單的應對方案

## 相互依賴的數據


## 依賴性的來源在哪裏

## 數據有依賴性導致的結果

## 依賴數據的簡單處理手法

## 簡單線性迴歸複習

## 練習題

### 數據

1. High-School-and-Beyond 數據 <br> 本數據來自1982年美國國家教育統計中心 (National Center for Education Statistics, NCES) 對美國公立學校和天主教會學校的一項普查。曾經在 Hierarchical Linear Model [@Raudenbush2002] 一書中作爲範例使用。其數據的變量名和各自含義如下：

```
minority           indicatory of student ethinicity (1 = minority, 0 = other)
female             pupil's gender
ses                standardized socio-economic status score
mathach            measure of mathematics achievement
size               school's total number of pupils
sector             school's sector: 1 = catholic, 0 = not catholic
schoolid           school identifier
```

2. PEFR 數據 <br> 數據本身是 17 名研究對象用兩種不同的測量方法測量兩次每個人的最大呼氣流速 (peak-expiratory-flow rate, PEFR)。最早在1986年的柳葉刀雜誌發表 [@Bland1986]。兩種測量法的名稱分別是 "Standard Wright" 和 "Mini Wright" peak flow meter。變量名和個字含義如下：


```
id                 participant identifier
wp1                standard wright measure at 1st occasion
wp2                standard wright measure at 2nd occasion
wm1                mini wright measure at 1st occasion
wm2                mini wright measure at 2nd occasion
```

### 問題

### 將 High-School-and-Beyond 數據導入 R 中，熟悉數據結構及內容，特別要注意觀察每個學校的學生特徵。


```{r hierex1-1, cache=TRUE}
hsb_selected <- read_dta("backupfiles/hsb_selected.dta")
length(unique(hsb_selected$schoolid)) ## number of school = 160
## create a subset data with only the first observation of each school
hsb <- hsb_selected[!duplicated(hsb_selected$schoolid), ]

## about 44 % of the schools are Catholic schools
with(hsb, tab1(sector, graph = FALSE, decimal = 2))

## among all the pupils, about 53% are females
with(hsb_selected, tab1(female, graph = FALSE, decimal = 2))

## among all the pupils, about 27.5% are from ethnic minorities
with(hsb_selected, tab1(minority, graph = FALSE, decimal = 2))
```

### 爲了簡便起見，接下來的分析只節選數據中前五所學校 188 名學生的數學成績，和 SES。分別計算每所學校的數學成績,及 SES 的平均值。


```{r hierex1-2, cache=TRUE}
hsb5 <- subset(hsb_selected, schoolid < 1320)
Mean_ses_math <- ddply(hsb5,~schoolid,summarise,mean_ses=mean(ses),mean_math=mean(mathach))
## the mean SES score ranges from -0.4255 to +0.5280
## the mean Maths score ranges from 7.636 to 16.255
Mean_ses_math
```

### 先無視掉學校這一分層變量，把所有學生看作是相互獨立的，擬合總體的 SES 和數學成績的線性迴歸 (Total regression model)。把該總體模型的預測值提取並存儲在數據庫中。

```{r mathses, cache=TRUE, echo=TRUE, fig.asp=.7, fig.width=8, fig.cap='Scatter plot of SES and math achievements among all pupils from first 5 schools, assuming that they are all independent', fig.align='center', out.width='80%', message=FALSE, warning=FALSE}
## plot the scatter of mathach and ses among these 5 schools

ggplot(hsb5, aes(x = ses, y = mathach)) + geom_point() +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.text.y = element_text(size = 15)) +
  labs(x = "SES", y = "Math achievement")  +
  xlim(-2.05, 2.05)+
  ylim(-10, 30) +
  theme(axis.title = element_text(size = 17), axis.text = element_text(size = 8),
        axis.line = element_line(colour = "black"),
    panel.border = element_blank(),
    panel.background = element_blank())
```


```{r hierex1-3, cache = TRUE}
Total_reg <- lm(mathach ~ ses, data = hsb5)
## the total regression model gives an estimated regression coefficient for the SES
## of each pupil equal to 3.31 (SE=0.66)
summary(Total_reg)
hsb5$Pred_T <- Total_reg$fitted.values # save the fitted values to the dataset
```

### 用各個學校 SES 和數學成績的均值擬合一個學校間的線性迴歸模型 (between regression model)。

```{r hierex1-4, cache=TRUE}
Btw_reg <- lm(mean_math ~ mean_ses, data = Mean_ses_math)
## the regression model for the school level variables (between model) gives
## an estimated regression coefficient of 7.29 (SE=1.41)
summary(Btw_reg)
Mean_ses_math$Pred_B <- Btw_reg$fitted.values # save the fitted values to the dataset
```

### 分別對每個學校內的學生進行 SES 和數學成績擬合線性迴歸模型。

```{r hierex1-5, cache=TRUE}
Within_schl1 <- lm(mathach ~ ses, data = hsb5[hsb5$schoolid == 1224,])
Within_schl2 <- lm(mathach ~ ses, data = hsb5[hsb5$schoolid == 1288,])
Within_schl3 <- lm(mathach ~ ses, data = hsb5[hsb5$schoolid == 1296,])
Within_schl4 <- lm(mathach ~ ses, data = hsb5[hsb5$schoolid == 1308,])
Within_schl5 <- lm(mathach ~ ses, data = hsb5[hsb5$schoolid == 1317,])
# the within school regressions gives estimated slopes which have a mean of 1.65
# and which ranges between 0.126 and 3.255
summary(c(Within_schl1$coefficients[2], Within_schl2$coefficients[2],
      Within_schl3$coefficients[2], Within_schl4$coefficients[2],
      Within_schl5$coefficients[2]))

# the SEs ranging between 1.21 and 3.00
summary(c(summary(Within_schl1)$coefficients[4],
          summary(Within_schl2)$coefficients[4],
          summary(Within_schl3)$coefficients[4],
          summary(Within_schl4)$coefficients[4],
          summary(Within_schl5)$coefficients[4]))

hsb5$Pred_W <- c(Within_schl1$fitted.values, Within_schl2$fitted.values,
      Within_schl3$fitted.values, Within_schl4$fitted.values,
      Within_schl5$fitted.values) ## save the predicted value into the dataset
```

### 比較三種模型計算的數學成績的擬合值，他們一致？還是有所不同？爲什麼會有不同？

- 總體模型 (Total regression model) 實際上無視了學生的性別，種族等可能帶來的混雜效果；
- 學校間模型 (Between model) 估計的實際上是**SES均值**每增加一個單位，與之對應的**數學平均成績**的改變量，**這個模型絕對不可用與評估個人的 SES 與數學成績之間的關係**；
- 學校內模型 (Within model) 擬合的 SES 與數學成績之間的關係變得十分地不精確 (SEs are fairly large)，變化幅度也很大。


### 把三種模型的數學成績擬合值散點圖繪製在同一張圖內。


```{r mathses-3models, cache=TRUE, echo=TRUE, fig.height=6.5, fig.width=8, fig.cap='High-school-and-beyond data: Predicted values by Total, Between, and Within regression models', fig.align='center', out.width='80%', message=FALSE, warning=FALSE}

Mean <- Mean_ses_math[, 1:3]
names(Mean) <- c("schoolid", "ses", "Pred_W")


ggplot(hsb5, aes(x = ses, y = Pred_W, group = schoolid)) +
  geom_line(linetype = 2, size = 1) +
  geom_abline(intercept = Total_reg$coefficients[1], slope = Total_reg$coefficients[2],
               colour = "dark blue") +
  geom_abline(intercept = Btw_reg$coefficients[1], slope = Btw_reg$coefficients[2],
               colour = "red") +
  geom_point(data = Mean, shape = 17, size = 4, colour = "Red") +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.text.y = element_text(size = 15)) +
  labs(x = "SES", y = "Fitted regression lines (Maths achievement)")  +
  xlim(-2.05, 2.05)+
  ylim(5, 20) +
  theme(axis.title = element_text(size = 17), axis.text = element_text(size = 8),
        axis.line = element_line(colour = "black"),
    panel.border = element_blank(),
    panel.background = element_blank()) + theme(plot.caption = element_text(size = 12,
  hjust = 0)) + labs(caption = "Black dash line: Within regression model;
Blue solid line: Total regression model;
Red solid line: Between regression model;
Red triangle: School mean values")
```

### 用這 5 個學校的數據擬合一個固定效應線性迴歸模型


```{r hierex1-8, cache=TRUE}
Fixed_reg <- lm(mathach ~ ses + factor(schoolid), data = hsb5)

## Fitting a fixed effect model to these data is equivalent to forcing
## a common slope onto the five within regression models. It gives an
## estimated slope of 1.789 (SE=0.76), close to their average of 1.64799.
## Note that controlling for female, minority, and sector but not for
## schoolid leads to roughly the same estimate (slope = 1.68, SE=0.75)

summary(Fixed_reg)
summary(lm(mathach ~ ses + female + minority + sector, data = hsb5))
```

### 讀入 PEFR 數據。

```{r hierex1-9, cache=TRUE}
pefr <- read_dta("backupfiles/pefr.dta")
# the data are in wide format
pefr

# transform data into long format
pefr_long <- pefr %>%
  gather(key, value, -id) %>%
  separate(key, into = c("measurement", "occasion"), sep = 2) %>%
  arrange(id, occasion) %>%
  spread(measurement, value)
pefr_long
```

```{r tworecordings, cache=TRUE, echo=TRUE, fig.height=5.5, fig.width=7.5, fig.cap='Two recordings of PEFR taken with the standard Wright meter', fig.align='center', out.width='80%', message=FALSE, warning=FALSE}

## figure shows slightly closer agreement between the repeated measures of standard Wright,
## than between those of Mini Wright

ggplot(pefr_long, aes(x = id, y = wp, fill = occasion)) +
  geom_point(size = 4, shape = 21) +
  geom_hline(yintercept = mean(pefr_long$wp), colour = "red") +
  theme_bw() +
  scale_x_continuous(breaks = 1:17)+
  theme(axis.text = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.text.y = element_text(size = 15)) +
  labs(x = "Subject ID", y = "W Measurements")  +
  theme(axis.title = element_text(size = 17), axis.text = element_text(size = 8),
        axis.line = element_line(colour = "black"),
    panel.border = element_blank(),
    panel.background = element_blank())
```

### 求每個患者的 `wp` 兩次測量平均值

```{r hierex1-11, cache=TRUE}
# the means range from 171.5 to 644.5

with(pefr_long, summ(wp, by = id, graph = FALSE))
```

### 在 R 裏先用 ANOVA 分析個人的 `wp` 變異。再用 `lme4::lmer` 擬合用 `id` 作隨機效應的混合效應模型。確認後者報告的 `Std.Dev for id effect` 其實可以用 ANOVA 結果的 $\sqrt{\frac{\text{MMS-MSE}}{n}}$ (n 是每個個體重複測量值的個數)。

```{r hierex1-12, cache=TRUE, message=FALSE}
with(pefr_long, anova(lm(wp~factor(id))))

#library(lme4)
( fit <- lmer(wp ~ (1|id), data=pefr_long) )

sqrt((27600 - 234)/2)
```

### 擬合結果變量爲 `wp`，解釋變量爲 `id` 的簡單線性迴歸模型。用數學表達式描述這個模型。


```{r hierex1-13, cache=TRUE, message=FALSE}
Reg <- lm(wp ~ factor(id), data = pefr_long)

# The fixed effect regression model leads to the same ANOVA
# table. To the same estimate of the residual SD = (15.307)
# However, it does not give an estimate of the "SD of id effect"
# Instead it gives estimates of mean PEFR for participant number 1
# = 492 and estimates of the difference in means from him/her
# for all the other 16 pariticipants
anova(Reg)
summary(Reg)
```

上面的模型用數學表達式來描述就是：

$$
\begin{aligned}
Y_{ij} & = \alpha_1 + \delta_i + \varepsilon_{ij} \\
\text{Where } \delta_j & = \alpha_j - \alpha_1 \\
\text{and } \delta_1   & = 0
\end{aligned}
$$

### 將 `wp` 中心化之後，重新擬合相同的模型，把截距去除掉。寫下這個模型的數學表達式。


```{r hierex1-14, cache=TRUE, message=FALSE}
Reg1 <- lm((wp - mean(wp)) ~ 0 + factor(id), data = pefr_long)

# it leads to the same ANOVA table again, same residual SD
anova(Reg1)
summary(Reg1)
```


上面的模型用數學表達式來描述就是：

$$
\begin{aligned}
Y_{ij} - \mu & = \gamma_j + \varepsilon_{ij} \\
      Y_{ij} & = \mu +  \gamma_j + \varepsilon_{ij} \\
\text{Where } \mu & \text{ is the overall mean} \\
\text{and } \sum_{j=1}^J\gamma_j & = 0\\
\end{aligned}
$$

### 計算這些迴歸係數 (其實是不同羣之間的隨機截距) 的均值和標準差。


```{r hierex1-15, cache=TRUE, message=FALSE}
# the individual level intercepts have mean zero and SD = 117.47, larger than the estimated
# Std.Dev for id effect.
Reg1$coefficients
summ(Reg1$coefficients, graph = FALSE)
```


# 隨機截距模型 random intercept model

## 隨機截距模型的定義

## 隨機截距模型的參數估計

## 如何在 R 或 STATA 中進行隨機截距模型的擬合

## 隨機截距模型中的統計推斷

## 練習題

### 數據

1. GHQ 數據 <br> 該數據包含 12 名學生前後兩次回答 General Health Questionnaire (GHQ) 問卷獲得的數據。該問卷用於測量學生的心理壓力，其變量名和含義如下：


```
id        Student identifier
GHQ1      General Health Questionnaire score- 1st occasion
GHQ2      General Health Questionnaire score- 2nd occasion
```

2. Siblings 數據 <br> 該數據是來自一項對 3978 名媽媽關於她們 8604 名孩子的出生體重及健康狀況的問卷調查。該數據的變量名和含義如下：


```
momid     Mother identifier
idx       Baby identifier
mage      Maternal age (years)
meduc     Maternal education
gestat    gestational age (weeks)
birwt     Birth weight (g)
smoke     Maternal smoking (0 = no, 1 = yes)
male      Baby boy (0 = no, 1 = yes)
year      Year of birth
married   Maternal marital status (0 = no, 1 = yes)
hsgrad    Maternal high school education (0 = no, 1 = yes)
black     Maternal race (1 = black, 0 = other)
```


### 讀入 GHQ 數據，探索其內容，該數據是否是平衡數據 (balanced)？計算每名學生的兩次問卷成績平均分。

```{r hierex2-1, cache=TRUE, message=FALSE}
ghq <- read_dta("backupfiles/ghq.dta")
ghq

ghq <- ghq %>%
  mutate(mean = (GHQ1 + GHQ2)/2)

# each student has 2 observations (i.e. n_j = n = 2)
# and therefore the data are balanced.
# the overall mean is 10.167 and its SD is 6.073
with(ghq, summ(mean, graph = FALSE))
```

### 把數據從寬 (wide) 改變成長 (long) 的形式


```{r hierex2-2, cache=TRUE, message=FALSE}

# transform data into long format
ghq_long <- ghq %>%
  gather(key, value, -id, -mean) %>%
  separate(key, into = c("measurement", "occasion"), sep = 3) %>%
  arrange(id, occasion) %>%
  spread(measurement, value)
ghq_long

# after reshaping there are 24 records. the summary statistics are
# overall mean sd and min max
with(ghq_long, summ(GHQ, graph = FALSE))
# between groups mean sd and min
summ(ghq_long[!duplicated(ghq_long$id), ]$mean, graph = FALSE)
# within groups mean sd and min (came from the difference between
# the overall mean and the within difference) observations for
# each group = 2
ghq_long <- ghq_long %>%
  mutate(dif_GHQ = mean(GHQ) - (GHQ - mean))
with(ghq_long, summ(dif_GHQ, graph = FALSE))
```

GHQ 的分佈並不左右對稱。

```{r  histGHQ, cache=TRUE, echo=FALSE, fig.height=5.5, fig.width=7.5, fig.cap='Histogram of GHQ by occasion', fig.align='center', out.width='80%', message=FALSE, warning=FALSE}

ggplot(ghq_long, aes(x = GHQ, ..density.. , fill = occasion)) +
geom_histogram(position = "identity",binwidth= 5.5) + facet_wrap(~occasion) +
theme_bw() +
#  scale_x_continuous(breaks = 1:17)+
  theme(axis.text = element_text(size = 15),
  axis.text.x = element_text(size = 15),
  axis.text.y = element_text(size = 15)) +
  labs(x = "GHQ", y = "Density")  +
  theme(axis.title = element_text(size = 17), axis.text = element_text(size = 8),
        axis.line = element_line(colour = "black"),
    panel.border = element_blank(),
    panel.background = element_blank())
```


### 對數據按照 `id` 分層進行 ANOVA

```{r hierex2-3, cache=TRUE, message=FALSE}
with(ghq_long, anova(lm(GHQ~factor(id))))

#library(lme4)
( fit <- lmer(GHQ ~ (1|id), data=ghq_long) )
```

$\sigma_u, \sigma_e$ 的估計值分別是 5.92 (between)， 1.91 (within)。可以計算層間相關係數 (intra-class correlation) $\hat\lambda = \frac{\sigma^2_u}{\sigma^2_u + \sigma^2_e} = 0.905$。且 $\hat\sigma_u = \sqrt{\frac{73.8 - 3.7}{2}} = 5.92$，和前一次練習一樣地，這個隨機效應的方差，可以通過方差分析表格來直接手動計算 (當且僅當分層數據是**平衡狀態**的)。和前面計算的樣本數據比較，樣本層間標準差是高估了的 (sample between variance = 6.073 > 5.92)，相反樣本層內標準差 (within sd) 則是低估了的 (sample within sd = 1.383 < 1.91)。兩個層內標準差的關係是：

$$
\sqrt{1.383^2\times\frac{23}{12}} = 1.91
$$


### 用 R 裏的 `nlme` 包，使用限制性極大似然法 (restricted maximum likelihood, REML) 擬合截距混合效應模型，比較其結果和前文中隨機效應 ANOVA 的結果

```{r hierex2-4, cache=TRUE, message=FALSE}
summary(nlme::lme(fixed = GHQ ~ 1, random = ~ 1 | id, data = ghq_long, method = "REML"))
```

截距混合效應模型的參數估計和隨機效應 ANOVA 的參數估計是一樣的。

### 用極大似然法 (maximum likelihood, ML) `method = "ML"` 重新擬合前面的混合效應模型，比較結果有什麼不同。


```{r hierex2-5, cache=TRUE, message=FALSE}
#( fit <- lmer(GHQ ~ (1|id), data=ghq_long, REML = FALSE) ) # same but from `lme4` package

summary(lme(fixed = GHQ ~ 1, random = ~ 1 | id, data = ghq_long, method = "ML"))
```

用極大似然法估計的隨機殘差標準差 $\sigma_e$ 和 REML/ANOVA 法估計的相同，但是隨機效應標準差 $\sigma_u$ 略小 5.65 < 5.92。


### 用簡單線性迴歸擬合一個固定效應模型

```{r hierex2-6, cache=TRUE, message=FALSE}
Fixed_reg <- lm(GHQ-mean(GHQ) ~ 0 + factor(id), data = ghq_long)
summary(Fixed_reg)
```

可以看到輸出報告最底段部分 `Residual standard error: 1.91 on 12 degrees of freedom` 就是前文三種不同模型擬合的隨機殘差效應的標準差。在 STATA 裏被叫做 `Root MSE`。

### 計算這些隨機截距的均值和標準差

```{r hierex2-7, cache=TRUE, message=FALSE}
summ(Fixed_reg$coefficients, graph = FALSE)
```

這裏僅僅用固定效應模型時，不同羣截距的均值雖然和用混合效應模型估計的一樣爲零，但是其估計的標準差要大於無論是 REML (5.92) 或者是 ML (5.65) 估計值的大小，其實這裏簡單線性迴歸給出的截距均值，就是本練習一開始讓你計算的樣本均值的標準差 (between group sd)。這是因爲**簡單線性迴歸 (固定效應模型) 忽視了這些不同組的均值的不確定性**。

### 忽略掉所有的分層和解釋變量擬合 `GHQ` 的簡單線性迴歸

```{r hierex2-8, cache=TRUE, message=FALSE}
Fixed_simple <- lm(GHQ ~ 1, data = ghq_long)
summary(Fixed_simple)
```

此時的模型估計的 `Residual standard error: 6.09 on 23 degrees of freedom` 其實就是一開始讓你計算的樣本整體的標準差 (overall sd)


### 用分層的穩健法 (三明治標準誤法) 計算簡單線性迴歸時，截距的標準誤差，和簡單線性迴歸時的結果作比較


```{r hierex2-9, cache=TRUE, message=FALSE}
# sandwich robust method with cluster id

robustReg <- clubSandwich::coef_test(Fixed_simple, vcov = "CR1", cluster = ghq_long$id)

rob.std.err <- robustReg$SE
naive.std.err<-summary(Fixed_simple)$coefficients[,2]
better.table <- cbind("Estimate" = coef(Fixed_simple),
                      "Naive SE" = naive.std.err,
                      "Pr(>|z|)" = 2 * pt(abs(coef(Fixed_simple)/naive.std.err), df=nrow(ghq_long)-2, lower.tail = FALSE),
                      "LL" = coef(Fixed_simple) - 1.96 * naive.std.err,
                      "UL" = coef(Fixed_simple) + 1.96 * naive.std.err,
                      "Robust SE" = rob.std.err,
                      "Pr(>|z|)" = 2 * pt(abs(coef(Fixed_simple)/rob.std.err), df=nrow(ghq_long)-2,
lower.tail = FALSE),
                      "LL" = coef(Fixed_simple) - qt(df=robustReg$df, 0.975) * rob.std.err,
                      "UL" = coef(Fixed_simple) + qt(df=robustReg$df, 0.975) * rob.std.err)
rownames(better.table)<-c("Constant")
better.table
```

### 讀入 `siblings` 數據。先總結嬰兒的出生體重，思考這個數據中嬰兒出生體重之間是否可能存在關聯性？它的來源是哪裏。用這個數據擬合兩個混合效應模型 (ML, REML)，不加入任何解釋變量。


```{r hierex2-10, cache=TRUE, message=FALSE}
siblings <- read_dta("backupfiles/siblings.dta")
Fixed_ml <- lme(fixed = birwt ~ 1, random = ~ 1 | momid, data = siblings, method = "ML")
summary(Fixed_ml)

Fixed_reml <- lme(fixed = birwt ~ 1, random = ~ 1 | momid, data = siblings, method = "REML")
summary(Fixed_reml)
```

由於該數據樣本量足夠大 (混合效應模型中等同於說數據的層數足夠多)


#  隨機截距模型中加入共變量

## 多重線性迴歸的延伸

## `siblings` 數據中新生兒體重的實例

## 賦值予隨機效應成分

## 混合效應模型的診斷

## 分層階段的協方差

## 層內層間效應估計

## 到底選擇固定還是混合模型？


## 練習題目


### 把 High-school-and-Beyong 數據讀入 R 中。

```{r hierex3-1, cache=TRUE, message=FALSE}
hsb_selected <- read_dta("backupfiles/hsb_selected.dta")
length(unique(hsb_selected$schoolid)) ## number of school = 160
## create a subset data with only the first observation of each school
hsb <- hsb_selected[!duplicated(hsb_selected$schoolid), ]

## about 44 % of the schools are Catholic schools
with(hsb, tab1(sector, graph = FALSE, decimal = 2))

## among all the schools, average school size is 1098
with(hsb, summ(size, graph = FALSE, decimal = 2))


## among all the pupils, about 53% are females
with(hsb_selected, tab1(female, graph = FALSE, decimal = 2))

## among all the pupils, about 27.5% are from ethnic minorities
with(hsb_selected, tab1(minority, graph = FALSE, decimal = 2))
```

### 擬合兩個隨機截距模型 (ML, REML)，結果變量用 `mathach`，解釋變量用 `ses`。觀察結果是否不同。


```{r hierex3-2, cache=TRUE, message=FALSE}
Fixed_reml <- lme(fixed = mathach ~ ses, random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)

Fixed_ml <- lme(fixed = mathach ~ ses, random = ~ 1 | schoolid, data = hsb_selected, method = "ML")
summary(Fixed_ml)
```

其實由於樣本量 (層數) 足夠多，兩個隨機截距模型給出的參數估計十分接近。


### 觀察學校類型是否爲天主教學校 `sector` 的分佈，把它加入剛擬合的兩個隨機截距模型，它們估計的隨機效應標準差 $\hat\sigma_u$，和隨機誤差標準差 $\hat\sigma_e$，和之前有什麼不同？ “ML，REML” 的選用對結果有影響嗎？


```{r hierex3-3, cache=TRUE, message=FALSE}
Fixed_reml <- lme(fixed = mathach ~ ses + factor(sector), random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)

Fixed_ml <- lme(fixed = mathach ~ ses + factor(sector), random = ~ 1 | schoolid, data = hsb_selected, method = "ML")
summary(Fixed_ml)
```

可以看出，`sector` 變量在學校層面上都是沒有變化的，所以加它進入混合效應的固定部分，只會對隨機效應標準差 (within level/cluster/group error) $\hat\sigma_u$ 的估計造成影響，隨機誤差標準差 $\hat\sigma_e$ 則幾乎不受影響。同樣的 “ML, REML” 兩種方法對結果的影響微乎其微。

### 現在把學校規模 `size` 這一變量加入混合效應模型的固定效應部分，記得先把該變量中心化，並除以 100，會有助於對結果的解釋 (比平均值每增加100名學生)。仔細觀察模型結果中隨機效應標準差和隨機誤差標準殘差的變化。


```{r hierex3-4, cache=TRUE, message=FALSE}
hsb_selected <- hsb_selected %>%
  mutate(c_size = (size - with(hsb, mean(size)))/100)

Fixed_reml <- lme(fixed = mathach ~ ses + factor(sector) + c_size, random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)

Fixed_ml <- lme(fixed = mathach ~ ses + factor(sector) + c_size, random = ~ 1 | schoolid, data = hsb_selected, method = "ML")
summary(Fixed_ml)
```

增加了 `size` 進入混合效應模型的固定效應部分，對兩種參數估計方法輸出的結果 $(\hat\sigma_u, \hat\sigma_e)$ 並沒有太大的影響。


### 在模型的固定效應部分增加 `size*sector` 的交互作用項。觀察輸出結果中該交互作用項是否有意義。用什麼檢驗方法判斷這個交互作用項能否幫助模型更加擬合數據？


```{r hierex3-5, cache=TRUE, message=FALSE}
Fixed_reml <- lme(fixed = mathach ~ ses + factor(sector)*c_size, random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)

Fixed_ml <- lme(fixed = mathach ~ ses + factor(sector)*c_size, random = ~ 1 | schoolid, data = hsb_selected, method = "ML")
summary(Fixed_ml)
```

在兩個估計方法的包工中，交互作用項均不具有統計學意義。

### 把上面八個模型估計的隨機效應標準差，和隨機誤差標準差總結成表格，它們之間有什麼規律嗎？


```{r hierex3-6, echo=FALSE, cache=TRUE, eval=FALSE}
library(knitr)
library(kableExtra)
dt <- read.csv("backupfiles/hierPractical3tb1.csv", header = T)
names(dt) <- c("Model with", "sigma_u", "sigma_e", "sigma_u", "sigma_e")
kable(dt, "html",  align = "c", caption = "Random effect sd and random residual sd from previous 8 mixed effect models") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"),full_width = F, position = "center") %>%
  add_header_above(c(" " = 1,"REML" = 2, "ML" = 2))
```

<table class="table table-striped table-bordered" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Random effect sd and random residual sd from previous 8 mixed effect models</caption>
 <thead>
<tr>
<th style="border-bottom:hidden" colspan="1"></th>
<th style="text-align:center; border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;" colspan="2"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px;">REML</div></th>
<th style="text-align:center; border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;" colspan="2"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px;">ML</div></th>
</tr>
  <tr>
   <th style="text-align:center;"> Model with </th>
   <th style="text-align:center;"> $\sigma_u$ </th>
   <th style="text-align:center;"> $\sigma_e$ </th>
   <th style="text-align:center;"> $\sigma_u$ </th>
   <th style="text-align:center;"> $\sigma_e$ </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> ses </td>
   <td style="text-align:center;"> 2.184 </td>
   <td style="text-align:center;"> 6.085 </td>
   <td style="text-align:center;"> 2.175 </td>
   <td style="text-align:center;"> 6.085 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ses &amp; sector </td>
   <td style="text-align:center;"> 1.920 </td>
   <td style="text-align:center;"> 6.086 </td>
   <td style="text-align:center;"> 1.903 </td>
   <td style="text-align:center;"> 6.086 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ses, size &amp; sector </td>
   <td style="text-align:center;"> 1.907 </td>
   <td style="text-align:center;"> 6.086 </td>
   <td style="text-align:center;"> 1.883 </td>
   <td style="text-align:center;"> 6.085 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> ses, size &amp; sector  <br> &amp; size*sector </td>
   <td style="text-align:center;"> 1.887 </td>
   <td style="text-align:center;"> 6.086 </td>
   <td style="text-align:center;"> 1.854 </td>
   <td style="text-align:center;"> 6.086 </td>
  </tr>
</tbody>
</table>

$\hat\sigma_e$ 幾乎在所有模型的估計中都保持不變。因爲我們在固定效應中增加的共變量在學校層面 (level 2) 都是一樣的。也就是說對於同一學校的學生，新增的共變量是一模一樣沒有變化的，所以在個人水平 (level 1) 的隨機效應幾乎不會發生變化。且注意到 “ML” 極大似然法估計的隨機效應標準差比 “REML” 限制性極大似然估計法給出的結果略小 1% 左右。

### 在混合效應模型的固定效應部分增加學生性別 `female`，和學生是否是少數族裔 `minority` 兩個變量。再觀察 $\hat\sigma_u, \hat\sigma_e$ 是否發生變化？


```{r hierex3-7, echo=TRUE, cache=TRUE}
Fixed_reml <- lme(fixed = mathach ~ ses + factor(sector) + c_size + factor(female) + factor(minority), random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)

Fixed_ml <- lme(fixed = mathach ~ ses + factor(sector) + c_size + factor(female) + factor(minority), random = ~ 1 | schoolid, data = hsb_selected, method = "ML")
summary(Fixed_ml)
```

混合效應模型的固定效應部分增加了學生性別，以及是否是少數族裔以後，“ML/REML” 估計的 $\hat\sigma_u, \hat\sigma_e$ 均發生了顯著變化。因爲它們在個人水平都不一樣 (level 1, within group random residuals)。

### 檢查學生性別和族裔是否和學校是否是天主教會學校有關係，先作分類型數據的分佈表格，然後把它們各自與 `sector` 的交互作用項加入混合效應模型中的固定效應部分，記錄下此時的 $\hat\sigma_u, \hat\sigma_e$


```{r hierex3-8, echo=TRUE, cache=TRUE}
# Only minority is associated with sector. There are more pupils from
# ethnic minorities attending catholic schools
with(hsb_selected, tabpct( sector, minority, graph = FALSE))
with(hsb_selected, tabpct( sector, female, graph = FALSE))


## there was no significant interaction between female sex and sector so
## this is deleted from the final model
Fixed_reml <- lme(fixed = mathach ~ ses + factor(sector)*factor(female)  + c_size + factor(minority), random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)

## There is an interaction between minority and sector
Fixed_reml <- lme(fixed = mathach ~ ses + factor(sector)*factor(minority)  + c_size + factor(female), random = ~ 1 | schoolid, data = hsb_selected, method = "REML")
summary(Fixed_reml)
```

數據顯示，少數族裔更多地選擇天主教會學校學習。學生性別則與是否是天主教會學校之間沒有顯著的關係。少數族裔和教會學校之間的交互作用同時也被發現具有統計學意義。

### 對上面最後一個模型進行殘差分析和模型的診斷。



```{r hierex3-9, echo=TRUE, cache=TRUE}
#fit <- lmer(mathach ~ ses + factor(sector)*factor(minority) + c_size + 
#              factor(female) + (1| schoolid), data=hsb_selected)
#summary(fit)

hsb <- hsb %>%
  mutate(# extract the random effect (EB) residuals (at school level)
         uhat_eb = ranef(Fixed_reml)$`(Intercept)`, 
         # number of students in each school
         npupil = count(hsb_selected$schoolid)[2]$freq, 
         # shrinkage factor = sigma_u^2/(sigma_u^2+sigma_e^2/n_j)
         R = 1.474^2/(1.474^2 + (5.981^2)/npupil),
         # Empirical Bayes prediction of variance of uhat
         var_eb = R*1.474^2, 
         # standardize the uhat
         uhat_st = uhat_eb/sqrt(var_eb))

# extract the standardized random (EB) residuals (at pupil level)
hsb_selected$ehat <- residuals(Fixed_reml, level = 1, type = "normalized")
```

```{r level2-residuals, cache=TRUE, echo=TRUE, fig.height=5.5, fig.width=11, fig.cap='Histogram and Q-Q plot of cluster (school) level standardized residuals for the intercept', fig.align='center', out.width='80%', message=FALSE, warning=FALSE}
par(mfrow=c(1,2))
hist(hsb$uhat_st, freq = FALSE, breaks = 12, col='lightblue')
qqnorm(hsb$uhat_st, ylab = "Standardized level 2 (school) residuals"); qqline(hsb$uhat_st, col=2)
```
```{r level1-residuals, cache=TRUE, echo=TRUE, fig.height=5.5, fig.width=11, fig.cap='Histogram and Q-Q plot of individual (pupil) level standardized residuals for the intercept', fig.align='center', out.width='80%', message=FALSE, warning=FALSE}
par(mfrow=c(1,2))
hist(hsb_selected$ehat, freq = FALSE, breaks = 38, col='lightblue')
qqnorm(hsb_selected$ehat,  ylab = "Standardized level 1 (pupil) residuals"); qqline(hsb_selected$ehat, col=2)
```

### 通過剛剛所求的隨機效應方差的殘差，確認哪個學校存在相對極端的值。

```{r hierex3-10, echo=TRUE, cache=TRUE}
summ(hsb$uhat_st, graph = FALSE)
hsb[with(hsb, which(uhat_st > 2.5)),  c(7, 5, 6, 12)]
hsb[with(hsb, which(uhat_st < -2.5)), c(7, 5, 6, 12)]
```

所以，此處可以看出，隨機效應殘差下提示的隨機效應標準差可能比較極端的有上面這三所規模較小的學校。其中一所是天主教會學校，另外兩所是非天主教會學校。